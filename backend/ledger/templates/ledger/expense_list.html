{% extends 'base.html' %} 

{% block title %} Expenses {% endblock %} 

{% load crispy_forms_tags %} 

{% block content %} 

<div class="card shadow">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <span><i class="fa fa-table" aria-hidden="true"></i> Expenses</span>
      <span>
        <button id="btn-view_last_month" class="btn btn-sm btn-dark">
          Last Month
        </button>
        <button id="btn-view_last_3_months" class="btn btn-sm btn-dark">
          Last 3 Months
        </button>
      </span>
    </div>
  </div>
  <div class="card-body">
    <form action="{% url 'ledger:ExpenseList' %}" method="get">
      <div class="row">
        {% include "_datepicker_from_to.html" %}
        <div class="col-sm-2 px-1">
          <button id="btn-filter_results" class="btn btn-sm btn-secondary btn-block">Filter by Date</button>
        </div>
        <div class="col-sm-2 px-1">
          <a 
            href="{% url 'ledger:NewExpense' %}"
            id="btn-new_expense" class="btn btn-sm btn-success btn-block">New Expense</a>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-sm-4">
          <input
            class="form-control form-control-sm"
            name="q"
            value="{{ last_query }}"
            type="text"
            placeholder="Search vendor"
          />
        </div>
        <div class="col-sm-6">
          {% if is_paginated %}
          <ul class="pagination pagination-sm">
            <li class="page-item">
              <a
                href="{% url 'ledger:ExpenseList' %}?q={{ last_query }}&page=1"
                class="page-link"
              >
                First
              </a>
            </li>
            {% if page_obj.has_previous %}
            <li class="page-item">
              <a
                href="{% url 'ledger:ExpenseList' %}?q={{ last_query }}&page={{ page_obj.previous_page_number }}"
                class="page-link"
              >
                {{ page_obj.previous_page_number }}
              </a>
            </li>
            {% endif %}
            <li class="page-item active">
              <a
                href="{% url 'ledger:ExpenseList' %}?q={{ last_query }}&page={{ page_obj.number }}"
                class="page-link"
              >
                {{ page_obj.number }}
              </a>
            </li>
            {% if page_obj.has_next %}
            <li class="page-item">
              <a
                href="{% url 'ledger:ExpenseList' %}?q={{ last_query }}&page={{ page_obj.next_page_number }}"
                class="page-link"
              >
                {{ page_obj.next_page_number }}
              </a>
            </li>
            {% endif %}
            <li class="page-item">
              <a
                href="{% url 'ledger:ExpenseList' %}?q={{ last_query }}&page=last"
                class="page-link"
              >
                Last ({{ page_obj.paginator.num_pages }})
              </a>
            </li>
          </ul>
        {% endif %}
        </div>
        <div class="col-sm-2 px-1">
          <button id="btn-export_excel" class="btn btn-sm btn-info btn-block">Export Excel</button>
        </div>
      </div>
    </form>
    
    {% if expense_list_obj %}
    <table class="table table-hover table-sm table-striped">
      <thead>
        <tr>
          <th scope="col">Invoice</th>
          <th scope="col">Paid Date</th>
          <th scope="col">Payee</th>
          <th scope="col">Category</th>
          <th scope="col">Amount</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expense_list_obj %}

        <tr>
          <td>{{ expense.invoice_date|date:"d-m-y" }}</td>
          <td>{{ expense.expected_date|date:"d-m-y" }}</td>
          <td>{{ expense.payee }}</td>
          <td>{{ expense.category.name }}</td>
          <td class="text-monospace text-right">{{ expense.amount }}</td>
          <td>
            <a
              href="{% url 'ledger:ExpenseUpdate' expense.pk %}"
              class="btn-expense_update btn btn-sm btn-primary"
            >
              <i class="fad fa-file-alt"></i>
            </button>
            {% if expense.category.name == "Drugs" %}
            <a
              href="{% url 'drugdb:BillDrugDeliveryView' expense.pk %}"
              class="btn btn-sm btn-info"
            >
              <i class="fad fa-layer-plus"></i>
            </a>
            {% endif %}
          </td>
        </tr>

        {% endfor %}
      </tbody>
    </table>

    {% else %}

    <p>No expenses in database</p>

    {% endif %}
  </div>
</div>

{% endblock %} 

{% block extrascripts %}

<script type="text/javascript">
  $(document).ready(function () {
    $(".expense-item-update").each(function () {
      $(this).modalForm({
        formURL: $(this).data("id"),
      });
    });

    $("#btn-add_expense").modalForm({
      formURL: "{% url 'ledger:NewExpenseModal' %}",
    });
    $('#datepicker_from').datetimepicker({
      format: 'L'
    });
    $('#datepicker_to').datetimepicker({
      format: 'L',
      useCurrent: false
    });
    $("#datepicker_from").on("change.datetimepicker", function (e) {
        $('#datepicker_to').datetimepicker('minDate', e.date);
    });
    $("#datepicker_from").on("change.datetimepicker", function (e) {
        $('#datepickerto').datetimepicker('maxDate', e.date);
    });

  });
</script>
{% endblock %}
